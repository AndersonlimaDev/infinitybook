<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Catálogos Digitais</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React e ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel para traduzir JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        canvas { max-width: 100%; height: auto; }
        .book-shadow { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- ÍCONES SVG INTERNOS ---
        const Icon = ({ path, className = "w-5 h-5" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Book: (props) => <Icon {...props} path={<><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5Z"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></>} />,
            Upload: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            ChevronLeft: (props) => <Icon {...props} path={<polyline points="15 18 9 12 15 6"/>} />,
            ChevronRight: (props) => <Icon {...props} path={<polyline points="9 18 15 12 9 6"/>} />,
            Search: (props) => <Icon {...props} path={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />,
            FileText: (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></>} />,
            Loader2: (props) => <Icon {...props} className={`${props.className} animate-spin`} path={<path d="M21 12a9 9 0 1 1-6.219-8.56"/>} />,
            X: (props) => <Icon {...props} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
            FolderPlus: (props) => <Icon {...props} path={<><path d="M12 10v6"/><path d="M9 13h6"/><path d="M20 20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H20a2 2 0 0 1 2 2v2"/></>} />,
            Folder: (props) => <Icon {...props} path={<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>} />,
            ArrowLeft: (props) => <Icon {...props} path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />
        };

        // --- CONFIGURAÇÃO E UTILITÁRIOS ---
        const PDFJS_CDN = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
        const PDFJS_WORKER_CDN = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

        const dbName = "CatalogDB";
        const stores = {
            catalogs: "catalogs",
            brands: "brands"
        };

        const initDB = () => {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 2); // Versão incrementada para novas stores
            request.onupgradeneeded = (e) => {
              const db = e.target.result;
              if (!db.objectStoreNames.contains(stores.catalogs)) {
                db.createObjectStore(stores.catalogs, { keyPath: "id" });
              }
              if (!db.objectStoreNames.contains(stores.brands)) {
                db.createObjectStore(stores.brands, { keyPath: "id" });
              }
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        };

        const saveToDB = async (storeName, item) => {
          const db = await initDB();
          return new Promise((resolve, reject) => {
            const transaction = db.transaction(storeName, "readwrite");
            const store = transaction.objectStore(storeName);
            const request = store.put(item);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        };

        const getAllFromDB = async (storeName) => {
          const db = await initDB();
          return new Promise((resolve, reject) => {
            const transaction = db.transaction(storeName, "readonly");
            const store = transaction.objectStore(storeName);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });
        };

        const deleteFromDB = async (storeName, id) => {
          const db = await initDB();
          return new Promise((resolve, reject) => {
            const transaction = db.transaction(storeName, "readwrite");
            const store = transaction.objectStore(storeName);
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        };

        // --- COMPONENTE DO VISUALIZADOR ---
        const BookViewer = ({ catalog, onClose }) => {
          const [numPages, setNumPages] = useState(0);
          const [currentPage, setCurrentPage] = useState(1);
          const [loading, setLoading] = useState(true);
          const [scale, setScale] = useState(0.8);
          const [pdfDoc, setPdfDoc] = useState(null);
          const [error, setError] = useState(null);
          
          const canvasLeftRef = useRef(null);
          const canvasRightRef = useRef(null);
          const containerRef = useRef(null);

          useEffect(() => {
            const loadPdf = async () => {
              setLoading(true);
              setError(null);
              try {
                if (!window.pdfjsLib) throw new Error("PDF.js não disponível.");
                const loadingTask = window.pdfjsLib.getDocument(catalog.data);
                const pdf = await loadingTask.promise;
                setPdfDoc(pdf);
                setNumPages(pdf.numPages);
              } catch (err) {
                setError("Erro ao carregar o PDF.");
              } finally {
                setLoading(false);
              }
            };
            loadPdf();
          }, [catalog]);

          const renderPage = useCallback(async (pageNum, canvas) => {
            if (!pdfDoc || !canvas) return;
            try {
              const page = await pdfDoc.getPage(pageNum);
              const viewport = page.getViewport({ scale: scale * 2 });
              const context = canvas.getContext('2d');
              canvas.height = viewport.height;
              canvas.width = viewport.width;
              await page.render({ canvasContext: context, viewport: viewport }).promise;
            } catch (err) { console.error(err); }
          }, [pdfDoc, scale]);

          useEffect(() => {
            if (!loading && pdfDoc) {
              if (currentPage === 1) {
                renderPage(1, canvasRightRef.current);
                if (canvasLeftRef.current) canvasLeftRef.current.width = 0;
              } else {
                renderPage(currentPage, canvasLeftRef.current);
                if (currentPage + 1 <= numPages) renderPage(currentPage + 1, canvasRightRef.current);
                else if (canvasRightRef.current) canvasRightRef.current.width = 0;
              }
            }
          }, [currentPage, loading, pdfDoc, renderPage, numPages]);

          const nextPage = () => {
            if (currentPage === 1 && numPages > 1) setCurrentPage(2);
            else if (currentPage + 2 <= numPages) setCurrentPage(currentPage + 2);
          };

          const prevPage = () => {
            if (currentPage === 2) setCurrentPage(1);
            else if (currentPage - 2 >= 2) setCurrentPage(currentPage - 2);
          };

          return (
            <div className="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center text-white">
              <div className="absolute top-0 w-full p-4 flex items-center justify-between bg-black/50 z-20">
                <div className="flex items-center gap-4">
                  <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors"><Icons.X /></button>
                  <div>
                    <h2 className="font-semibold text-sm sm:text-base">{catalog.name}</h2>
                    {!loading && <p className="text-[10px] text-slate-300">Página {currentPage === 1 ? '1' : `${currentPage}-${Math.min(currentPage + 1, numPages)}`} de {numPages}</p>}
                  </div>
                </div>
                <div className="flex items-center gap-2 bg-black/40 p-1 rounded-xl">
                  <button onClick={() => setScale(s => Math.max(s - 0.1, 0.3))} className="px-3 py-1 hover:bg-white/10 rounded-lg">-</button>
                  <span className="text-xs w-10 text-center">{Math.round(scale * 100)}%</span>
                  <button onClick={() => setScale(s => Math.min(s + 0.1, 3))} className="px-3 py-1 hover:bg-white/10 rounded-lg">+</button>
                </div>
              </div>

              <div className="flex-1 w-full flex items-center justify-center overflow-auto p-4 relative">
                {loading ? <Icons.Loader2 className="w-12 h-12 text-indigo-400" /> : error ? (
                  <div className="text-center"><Icons.AlertCircle className="w-12 h-12 text-red-400 mx-auto mb-4" /><p>{error}</p></div>
                ) : (
                  <div className="flex items-center justify-center">
                    <div className="flex bg-white book-shadow transition-all duration-500 overflow-hidden rounded-sm">
                      <div className={`${currentPage === 1 ? 'w-0' : 'w-auto border-r border-slate-200'}`}>
                        <canvas ref={canvasLeftRef} className="max-h-[85vh] block" />
                      </div>
                      <div className="w-auto relative">
                        <canvas ref={canvasRightRef} className="max-h-[85vh] block" />
                        {currentPage !== 1 && <div className="absolute top-0 left-0 w-10 h-full bg-gradient-to-r from-black/20 to-transparent pointer-events-none" />}
                      </div>
                    </div>
                  </div>
                )}
                {!loading && !error && (
                  <>
                    <button onClick={prevPage} disabled={currentPage === 1} className="absolute left-4 p-4 bg-black/50 hover:bg-black/70 disabled:opacity-0 rounded-full z-10"><Icons.ChevronLeft className="w-8 h-8" /></button>
                    <button onClick={nextPage} disabled={currentPage === numPages || (currentPage + 1 === numPages && currentPage !== 1)} className="absolute right-4 p-4 bg-black/50 hover:bg-black/70 disabled:opacity-0 rounded-full z-10"><Icons.ChevronRight className="w-8 h-8" /></button>
                  </>
                )}
              </div>
            </div>
          );
        };

        // --- COMPONENTE PRINCIPAL ---
        const App = () => {
          const [brands, setBrands] = useState([]);
          const [catalogs, setCatalogs] = useState([]);
          const [activeBrand, setActiveBrand] = useState(null);
          const [isViewerOpen, setIsViewerOpen] = useState(false);
          const [selectedPdf, setSelectedPdf] = useState(null);
          const [loading, setLoading] = useState(true);
          const [searchTerm, setSearchTerm] = useState("");
          const [showBrandModal, setShowBrandModal] = useState(false);
          const [newBrandName, setNewBrandName] = useState("");

          useEffect(() => {
            const load = async () => {
              try {
                const [bData, cData] = await Promise.all([
                    getAllFromDB(stores.brands),
                    getAllFromDB(stores.catalogs)
                ]);
                setBrands(bData || []);
                setCatalogs(cData || []);
              } catch (e) { console.error(e); }
              finally { setLoading(false); }
            };
            load();
            if (!window.pdfjsLib) {
              const script = document.createElement('script');
              script.src = PDFJS_CDN;
              script.onload = () => { window.pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_CDN; };
              document.head.appendChild(script);
            }
          }, []);

          const handleAddBrand = async () => {
            if (!newBrandName.trim()) return;
            const newBrand = { id: Date.now().toString(), name: newBrandName.trim() };
            await saveToDB(stores.brands, newBrand);
            setBrands([...brands, newBrand]);
            setNewBrandName("");
            setShowBrandModal(false);
          };

          const handleFileUpload = async (e) => {
            const files = Array.from(e.target.files);
            if (!activeBrand) return;
            setLoading(true);
            for (const file of files) {
              if (file.type !== 'application/pdf') continue;
              const base64 = await new Promise(r => { 
                const reader = new FileReader(); 
                reader.onload = (ev) => r(ev.target.result); 
                reader.readAsDataURL(file); 
              });
              const thumb = await generateThumbnail(base64);
              const newItem = { 
                id: Date.now() + Math.random().toString(36).substr(2, 9), 
                name: file.name.replace('.pdf', ''), 
                date: new Date().toLocaleDateString(), 
                data: base64, 
                thumbnail: thumb, 
                size: (file.size / (1024 * 1024)).toFixed(2) + " MB",
                brandId: activeBrand.id 
              };
              await saveToDB(stores.catalogs, newItem);
              setCatalogs(prev => [newItem, ...prev]);
            }
            setLoading(false);
          };

          const generateThumbnail = async (data) => {
            if (!window.pdfjsLib) return "";
            try {
              const pdf = await window.pdfjsLib.getDocument(data).promise;
              const page = await pdf.getPage(1);
              const viewport = page.getViewport({ scale: 0.3 });
              const canvas = document.createElement('canvas');
              canvas.height = viewport.height; canvas.width = viewport.width;
              await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
              return canvas.toDataURL();
            } catch (e) { return ""; }
          };

          const deleteBrand = async (id, e) => {
            e.stopPropagation();
            await deleteFromDB(stores.brands, id);
            // Opcional: deletar catálogos da marca ou deixá-los órfãos
            setBrands(prev => prev.filter(b => b.id !== id));
            if (activeBrand?.id === id) setActiveBrand(null);
          };

          const deleteCatalog = async (id, e) => {
            e.stopPropagation();
            await deleteFromDB(stores.catalogs, id);
            setCatalogs(prev => prev.filter(c => c.id !== id));
          };

          const filteredBrands = brands.filter(b => b.name.toLowerCase().includes(searchTerm.toLowerCase()));
          const filteredCatalogs = catalogs.filter(c => 
            c.brandId === activeBrand?.id && 
            c.name.toLowerCase().includes(searchTerm.toLowerCase())
          );

          return (
            <div className="min-h-screen">
              {/* Header */}
              <header className="bg-white border-b sticky top-0 z-10 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <button 
                        onClick={() => setActiveBrand(null)}
                        className={`flex items-center gap-2 p-1 rounded-lg transition-all ${!activeBrand ? 'text-indigo-600' : 'text-slate-500 hover:text-indigo-600'}`}
                    >
                        <Icons.Book className={!activeBrand ? 'text-indigo-600' : ''} />
                        <h1 className="font-bold text-xl hidden sm:block">Infinitybook</h1>
                    </button>
                    {activeBrand && (
                        <div className="flex items-center gap-2 text-slate-400">
                            <span>/</span>
                            <span className="text-slate-900 font-medium">{activeBrand.name}</span>
                        </div>
                    )}
                  </div>

                  <div className="flex-1 max-w-md mx-4 relative">
                    <Icons.Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4" />
                    <input 
                        type="text" 
                        placeholder={activeBrand ? "Procurar nesta marca..." : "Procurar marca..."} 
                        className="w-full pl-10 pr-4 py-2 bg-slate-100 rounded-full text-sm outline-none focus:ring-2 ring-indigo-500" 
                        value={searchTerm} 
                        onChange={(e) => setSearchTerm(e.target.value)} 
                    />
                  </div>

                  <div className="flex items-center gap-3">
                    {!activeBrand ? (
                        <button 
                            onClick={() => setShowBrandModal(true)}
                            className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-all text-sm font-medium"
                        >
                            <Icons.FolderPlus className="w-4 h-4" />
                            <span>Nova Marca</span>
                        </button>
                    ) : (
                        <label className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg cursor-pointer transition-all text-sm font-medium">
                            <Icons.Upload className="w-4 h-4" /> 
                            <span>Upload PDF</span>
                            <input type="file" accept=".pdf" className="hidden" onChange={handleFileUpload} multiple />
                        </label>
                    )}
                  </div>
                </div>
              </header>

              <main className="max-w-7xl mx-auto px-4 py-8">
                {/* Breadcrumb ou Botão Voltar */}
                {activeBrand && (
                    <button 
                        onClick={() => setActiveBrand(null)}
                        className="flex items-center gap-2 text-indigo-600 hover:text-indigo-800 mb-6 transition-all font-medium text-sm"
                    >
                        <Icons.ArrowLeft className="w-4 h-4" />
                        Voltar para Marcas
                    </button>
                )}

                {loading ? (
                  <div className="flex items-center justify-center py-24"><Icons.Loader2 className="w-8 h-8 text-indigo-600" /></div>
                ) : !activeBrand ? (
                  /* TELA DE MARCAS */
                  <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
                    {filteredBrands.map(brand => (
                        <div 
                            key={brand.id} 
                            onClick={() => setActiveBrand(brand)}
                            className="group flex flex-col items-center gap-3 p-4 bg-white rounded-xl border border-transparent hover:border-indigo-200 hover:shadow-md cursor-pointer transition-all relative"
                        >
                            <div className="w-16 h-16 sm:w-20 sm:h-20 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 group-hover:bg-indigo-100 transition-colors shadow-inner">
                                <Icons.Folder className="w-10 h-10" />
                            </div>
                            <span className="font-semibold text-slate-700 text-center truncate w-full">{brand.name}</span>
                            <button 
                                onClick={(e) => deleteBrand(brand.id, e)}
                                className="absolute top-1 right-1 p-2 text-red-400 opacity-0 group-hover:opacity-100 hover:text-red-600"
                            >
                                <Icons.Trash2 className="w-4 h-4" />
                            </button>
                        </div>
                    ))}
                    {filteredBrands.length === 0 && (
                        <div className="col-span-full py-20 text-center bg-white rounded-2xl border-2 border-dashed">
                            <Icons.Folder className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                            <p className="text-slate-500">Nenhuma marca criada. Clique em "Nova Marca" para começar.</p>
                        </div>
                    )}
                  </div>
                ) : (
                  /* TELA DE CATÁLOGOS DA MARCA */
                  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    {filteredCatalogs.map(c => (
                      <div key={c.id} onClick={() => { setSelectedPdf(c); setIsViewerOpen(true); }} className="group bg-white rounded-xl shadow-sm border overflow-hidden cursor-pointer hover:shadow-xl transition-all relative">
                        <div className="aspect-[3/4] bg-slate-100 overflow-hidden relative">
                          {c.thumbnail ? <img src={c.thumbnail} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center"><Icons.FileText className="text-slate-300 w-12 h-12" /></div>}
                          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/20 flex items-center justify-center transition-all">
                            <div className="bg-white p-3 rounded-full opacity-0 group-hover:opacity-100 shadow-lg"><Icons.Book className="w-6 h-6" /></div>
                          </div>
                        </div>
                        <div className="p-4">
                          <h3 className="font-bold text-slate-800 truncate text-sm">{c.name}</h3>
                          <p className="text-[10px] text-slate-500 mt-1">{c.date} • {c.size}</p>
                        </div>
                        <button onClick={(e) => deleteCatalog(c.id, e)} className="absolute top-2 right-2 p-2 bg-red-50 text-red-500 rounded-lg opacity-0 group-hover:opacity-100 hover:bg-red-500 hover:text-white transition-all"><Icons.Trash2 className="w-4 h-4" /></button>
                      </div>
                    ))}
                    {filteredCatalogs.length === 0 && (
                        <div className="col-span-full py-20 text-center bg-white rounded-2xl border-2 border-dashed">
                            <Icons.FileText className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                            <p className="text-slate-500">Essa marca ainda não possui catálogos. Faça upload de um PDF.</p>
                        </div>
                    )}
                  </div>
                )}
              </main>

              {/* Modal de Nova Marca */}
              {showBrandModal && (
                  <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
                      <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
                          <div className="flex items-center justify-between mb-4">
                              <h3 className="text-lg font-bold">Criar Nova Marca</h3>
                              <button onClick={() => setShowBrandModal(false)} className="text-slate-400 hover:text-slate-600"><Icons.X /></button>
                          </div>
                          <input 
                            autoFocus
                            type="text" 
                            placeholder="Nome da Marca (Ex: Kenner)" 
                            className="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 ring-indigo-500"
                            value={newBrandName}
                            onChange={(e) => setNewBrandName(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleAddBrand()}
                          />
                          <div className="flex gap-2">
                              <button onClick={() => setShowBrandModal(false)} className="flex-1 py-3 text-slate-600 hover:bg-slate-100 rounded-xl font-medium transition-all">Cancelar</button>
                              <button onClick={handleAddBrand} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">Criar</button>
                          </div>
                      </div>
                  </div>
              )}

              {isViewerOpen && selectedPdf && <BookViewer catalog={selectedPdf} onClose={() => setIsViewerOpen(false)} />}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>